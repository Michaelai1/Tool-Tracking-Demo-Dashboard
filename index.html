<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Tracking Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-100">
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold">Tool Tracking Dashboard</h1>
            <p class="text-blue-100 mt-1">Live monitoring of construction tools</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div id="loadingDiv" class="text-center py-20">
            <svg class="spinner mx-auto h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600 text-xl mt-4 font-semibold">Loading Dashboard Data...</p>
        </div>

        <div id="errorDiv" class="hidden text-center py-20">
            <div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-md mx-auto">
                <svg class="mx-auto h-12 w-12 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h2 class="text-2xl font-bold text-red-700 mb-2">Error Loading Dashboard</h2>
                <p class="text-red-600">Unable to fetch data from the server. Please try again later.</p>
            </div>
        </div>

        <div id="dashboardContent" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Total Tools</p>
                            <p id="totalTools" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                        <div class="bg-blue-100 rounded-full p-3">
                            <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Tools In Shop</p>
                            <p id="toolsInShop" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                        <div class="bg-green-100 rounded-full p-3">
                            <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-orange-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Tools Checked Out</p>
                            <p id="toolsCheckedOut" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                        <div class="bg-orange-100 rounded-full p-3">
                            <svg class="h-8 w-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Tools by Status</h2>
                    <canvas id="pieChart"></canvas>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Days in Use</h2>
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Live Inventory</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tool Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Holder</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Chart instances
        let pieChart = null;
        let barChart = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                const response = await fetch('https://michaelcarey.app.n8n.cloud/webhook/getDashboardData');
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                
                // Hide loading state
                document.getElementById('loadingDiv').classList.add('hidden');
                
                // Process and display data
                processDashboardData(data);
                
                // Show dashboard
                document.getElementById('dashboardContent').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                
                // Hide loading state and show error
                document.getElementById('loadingDiv').classList.add('hidden');
                document.getElementById('errorDiv').classList.remove('hidden');
            }
        }

        function processDashboardData(data) {
            // ========================================================
            // THIS IS THE FIX:
            // The data from n8n is already simple, so we just use it.
            // We change `data.map(record => record.fields)` to just `data`.
            const tools = data;
            // ========================================================
            
            // Calculate KPIs
            const totalTools = tools.length;
            const toolsInShop = tools.filter(tool => tool.Status === 'In Shop').length;
            const toolsCheckedOut = tools.filter(tool => tool.Status === 'Checked Out').length;
            
            // Update KPI cards
            document.getElementById('totalTools').textContent = totalTools;
            document.getElementById('toolsInShop').textContent = toolsInShop;
            document.getElementById('toolsCheckedOut').textContent = toolsCheckedOut;
            
            // Create pie chart for tools by status
            createPieChart(tools);
            
            // Create bar chart for days in use
            createBarChart(tools);
            
            // Populate inventory table
            populateInventoryTable(tools);
        }

        function createPieChart(tools) {
            // Count tools by status
            const statusCounts = {};
            tools.forEach(tool => {
                const status = tool.Status || 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            const ctx = document.getElementById('pieChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (pieChart) {
                pieChart.destroy();
            }
            
            pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#3B82F6', // blue
                            '#10B981', // green
                            '#F59E0B', // orange
                            '#EF4444', // red
                            '#8B5CF6', // purple
                            '#EC4899'  // pink
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function createBarChart(tools) {
            // Extract tool names and days in use
            const toolNames = tools.map(tool => tool['Tool Name'] || 'Unknown Tool');
            const daysInUse = tools.map(tool => tool['Days in Use'] || 0);
            
            const ctx = document.getElementById('barChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (barChart) {
                barChart.destroy();
            }
            
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: toolNames,
                    datasets: [{
                        label: 'Days in Use',
                        data: daysInUse,
                        backgroundColor: '#3B82F6',
                        borderColor: '#2563EB',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function populateInventoryTable(tools) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            tools.forEach(tool => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const toolName = tool['Tool Name'] || 'N/A';
                const status = tool.Status || 'Unknown';
                const currentHolder = tool['Current Holder'] || 'N/A';
                
                // Status badge styling
                let statusClass = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full ';
                if (status === 'In Shop') {
                    statusClass += 'bg-green-100 text-green-800';
                } else if (status === 'Checked Out') {
                    statusClass += 'bg-orange-100 text-orange-800';
                } else if (status === 'Needs Service') {
                    statusClass += 'bg-red-100 text-red-800';
                } else {
                    statusClass += 'bg-gray-100 text-gray-800';
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${toolName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="${statusClass}">${status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${currentHolder}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
    </script>
</body>
</html>
