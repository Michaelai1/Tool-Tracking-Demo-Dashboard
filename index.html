<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Tracking Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        /* Style for highlighting table rows */
        .highlight-service { background-color: #FFFBEB; border-left-color: #F59E0B !important; } /* Light yellow */
        .highlight-broken { background-color: #FFF1F2; border-left-color: #EF4444 !important; } /* Light red */
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold">Tool Tracking Dashboard</h1>
            <p class="text-blue-100 mt-1">Live monitoring of construction tools</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Loading State -->
        <div id="loadingDiv" class="text-center py-20">
            <svg class="spinner mx-auto h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600 text-xl mt-4 font-semibold">Loading Dashboard Data...</p>
        </div>

        <!-- Error State -->
        <div id="errorDiv" class="hidden text-center py-20">
            <div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-md mx-auto">
                <svg class="mx-auto h-12 w-12 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h2 class="text-2xl font-bold text-red-700 mb-2">Error Loading Dashboard</h2>
                <p class="text-red-600">Unable to fetch data from the server. Please try again later.</p>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden">
            <!-- KPI Cards - Now 4 columns for medium screens -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Tools -->
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Total Tools</p>
                            <p id="totalTools" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                        <div class="bg-blue-100 rounded-full p-3">
                           <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.977l-.51.342a6 6 0 01-3.86.977l-2.387-.477a2 2 0 00-1.022.547H3V19h18v-3.572h-1.572zM12 12a3 3 0 100-6 3 3 0 000 6z" /></svg>
                        </div>
                    </div>
                </div>
                <!-- Tools In Shop -->
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Tools In Shop</p>
                            <p id="toolsInShop" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                        <div class="bg-green-100 rounded-full p-3">
                           <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                    </div>
                </div>
                <!-- Tools Checked Out -->
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-orange-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Tools Checked Out</p>
                            <p id="toolsCheckedOut" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                        <div class="bg-orange-100 rounded-full p-3">
                           <svg class="h-8 w-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 10V6m0 16a8 8 0 100-16 8 8 0 000 16z" /></svg>
                        </div>
                    </div>
                </div>
                <!-- NEW: At-Risk Tools -->
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Tools At Risk</p>
                            <p id="toolsAtRisk" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                        <div class="bg-red-100 rounded-full p-3">
                            <svg class="h-8 w-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row - Still 2 columns -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Pie Chart: Tools by Status -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Tools by Status</h2>
                    <canvas id="statusPieChart"></canvas>
                </div>
                <!-- NEW: Pie Chart: Tools by Location -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Tools by Location</h2>
                    <canvas id="locationPieChart"></canvas>
                </div>
            </div>

            <!-- Bar Chart Row - Moved to its own row -->
            <div class="grid grid-cols-1 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Days in Use (Since Last Check-in)</h2>
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <!-- Inventory Table -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Live Inventory</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tool Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Holder</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Condition</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next Service</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Table rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Chart instances
        let statusPieChart = null;
        let locationPieChart = null; // New chart instance
        let barChart = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                const response = await fetch('https://michaelcarey.app.n8n.cloud/webhook/getDashboardData');
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                
                document.getElementById('loadingDiv').classList.add('hidden');
                processDashboardData(data);
                document.getElementById('dashboardContent').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('loadingDiv').classList.add('hidden');
                document.getElementById('errorDiv').classList.remove('hidden');
            }
        }

        function processDashboardData(data) {
            const tools = Array.isArray(data) ? data : [data];
            
            // Calculate KPIs
            const totalTools = tools.length;
            const toolsInShop = tools.filter(tool => tool.Status === 'In Shop').length;
            const toolsCheckedOut = tools.filter(tool => tool.Status === 'Checked Out').length;
            // NEW KPI: Count tools needing repair or in fair condition
            const toolsAtRisk = tools.filter(tool => tool.Condition === 'Needs Repair' || tool.Condition === 'Fair').length;

            // Update KPI cards
            document.getElementById('totalTools').textContent = totalTools;
            document.getElementById('toolsInShop').textContent = toolsInShop;
            document.getElementById('toolsCheckedOut').textContent = toolsCheckedOut;
            document.getElementById('toolsAtRisk').textContent = toolsAtRisk; // Update new card

            // Create charts
            createStatusPieChart(tools);
            createLocationPieChart(tools); // Call new chart function
            createBarChart(tools);
            
            // Populate inventory table
            populateInventoryTable(tools);
        }

        // Renamed function
        function createStatusPieChart(tools) {
            const statusCounts = {};
            tools.forEach(tool => {
                const status = tool.Status || 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            const ctx = document.getElementById('statusPieChart').getContext('2d');
            
            if (statusPieChart) {
                statusPieChart.destroy();
            }
            
            statusPieChart = new Chart(ctx, { // Use the renamed variable
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#10B981', // green (In Shop)
                            '#F59E0B', // orange (Checked Out)
                            '#EF4444', // red (Needs Service/Repair)
                            '#6B7280', // gray (Other)
                            '#3B82F6', // blue 
                            '#8B5CF6', // purple
                            '#EC4899'  // pink
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true, // Keep pie chart aspect ratio
                    plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 }}}}
                }
            });
        }

        // NEW function for Location Pie Chart
        function createLocationPieChart(tools) {
            const locationCounts = {};
            tools.forEach(tool => {
                const location = tool['Current Location'] || 'Unknown';
                locationCounts[location] = (locationCounts[location] || 0) + 1;
            });

            const ctx = document.getElementById('locationPieChart').getContext('2d');

            if (locationPieChart) {
                locationPieChart.destroy();
            }

            locationPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(locationCounts),
                    datasets: [{
                        data: Object.values(locationCounts),
                        backgroundColor: [ // Different color scheme
                            '#3B82F6', // blue
                            '#14B8A6', // teal
                            '#8B5CF6', // purple
                            '#EC4899', // pink
                            '#F59E0B', // orange
                            '#6B7280'  // gray
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true, // Keep aspect ratio
                    plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 }}}}
                }
            });
        }


        function createBarChart(tools) {
            // Sort tools by Days in Use, descending, for better visualization
            const sortedTools = [...tools].sort((a, b) => (b['Days in Use'] || 0) - (a['Days in Use'] || 0));

            const toolNames = sortedTools.map(tool => tool['Tool Name'] || 'Unknown Tool');
            const daysInUse = sortedTools.map(tool => tool['Days in Use'] || 0);
            
            const ctx = document.getElementById('barChart').getContext('2d');
            
            if (barChart) {
                barChart.destroy();
            }
            
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: toolNames,
                    datasets: [{
                        label: 'Days in Use',
                        data: daysInUse,
                        backgroundColor: '#3B82F6',
                        borderColor: '#2563EB',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allow bar chart to stretch vertically
                     indexAxis: 'y', // Optional: Makes labels easier to read if many tools
                    scales: {
                        y: { 
                           ticks: { autoSkip: false } // Ensure all labels are shown
                        },
                        x: { // Changed from y to x for horizontal bar chart
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function populateInventoryTable(tools) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date for comparison

            // Sort tools alphabetically for consistency
            tools.sort((a, b) => (a['Tool Name'] || '').localeCompare(b['Tool Name'] || ''));

            tools.forEach(tool => {
                const row = document.createElement('tr');
                row.className = 'border-l-4 border-transparent'; // Default border

                const toolName = tool['Tool Name'] || 'N/A';
                const status = tool.Status || 'Unknown';
                const currentHolder = tool['Current Holder'] || 'N/A';
                const condition = tool.Condition || 'N/A'; // Get condition
                const nextService = tool['Next Service Due'] || 'N/A'; // Get service date

                // --- NEW: Highlighting Logic ---
                let highlightClass = '';
                // 1. Check Condition
                if (condition === 'Needs Repair' || condition === 'Fair') {
                    highlightClass = ' highlight-broken'; // Apply red highlight class
                } 
                // 2. Check Service Date (only if not already highlighted red)
                else if (nextService && nextService !== 'N/A') {
                    const serviceDate = new Date(nextService);
                    // Check if the date is valid and in the past
                    if (!isNaN(serviceDate) && serviceDate < today) {
                        highlightClass = ' highlight-service'; // Apply yellow highlight class
                    }
                }
                row.className += highlightClass; // Add the class to the row
                // --- End Highlighting Logic ---


                // Status badge styling
                let statusClass = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full ';
                if (status === 'In Shop') statusClass += 'bg-green-100 text-green-800';
                else if (status === 'Checked Out') statusClass += 'bg-orange-100 text-orange-800';
                else if (status === 'Needs Service' || status === 'Out for Repair') statusClass += 'bg-red-100 text-red-800';
                else statusClass += 'bg-gray-100 text-gray-800';
                
                // Condition badge styling (similar to status)
                let conditionClass = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full ';
                 if (condition === 'Good') conditionClass += 'bg-green-100 text-green-800';
                 else if (condition === 'Fair') conditionClass += 'bg-yellow-100 text-yellow-800'; // Yellow for Fair
                 else if (condition === 'Needs Repair') conditionClass += 'bg-red-100 text-red-800';
                 else conditionClass += 'bg-gray-100 text-gray-800';


                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${toolName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="${statusClass}">${status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${currentHolder}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                         <span class="${conditionClass}">${condition}</span> 
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${nextService}</td> 
                `;
                
                tableBody.appendChild(row);
            });
        }
    </script>
</body>
</html>
